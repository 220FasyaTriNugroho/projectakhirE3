<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VirtualDiary E3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Courier+Prime&display=swap" rel="stylesheet">
    <style>
        /* VAR */
        :root {
            --book-width: 420px; --book-height: 580px;
            --classic-bg: #f4ecd8; --midnight-bg: #2c3e50; --lavender-bg: #f3e5f5;
            --cover-grey: #8a9ea8; --cover-dark: #6b7f88;
            --brass-light: #cfa76e; --brass-dark: #8c6a3a;
        }
        /* Layout & BG */
        body {
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://www.transparenttextures.com/patterns/wood-pattern.png'), #5d4037;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; perspective: 2000px; overflow: hidden; font-family: 'Cinzel', serif;
        }
        /* Book Structure */
        .book-container { position: relative; width: var(--book-width); height: var(--book-height); transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border-radius: 10px; }
        .book-container.open { transform: translateX(50%); }
        .page { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transform-origin: left; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); cursor: pointer; border-radius: 0 12px 12px 0; }
        .front, .back { position: absolute; width: 100%; height: 100%; top: 0; left: 0; backface-visibility: hidden; padding: 3rem 2.5rem; display: flex; flex-direction: column; box-shadow: inset 5px 0 15px rgba(0,0,0,0.1); background: #fff; }
        .back { transform: rotateY(180deg); border-radius: 12px 0 0 12px; box-shadow: inset -5px 0 15px rgba(0,0,0,0.1); }
        .page.flipped { transform: rotateY(-180deg); }
        
        /* Cover Style */
        .page.cover { z-index: 100; border-radius: 12px; }
        .page.cover .front { background: linear-gradient(135deg, var(--cover-grey), var(--cover-dark)); color: #333; border: 3px dashed rgba(0,0,0,0.2); align-items: center; justify-content: flex-start; padding-top: 5rem; }
        
        /* Themes */
        .classic .front, .classic .back { background: var(--classic-bg); color: #5d4037; border-left: 5px solid #d7ccc8; }
        .midnight .front, .midnight .back { background: var(--midnight-bg); color: #eceff1; border-left: 5px solid #455a64; }
        .midnight .content-lines { background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); color: #ccc; }
        .lavender .front, .lavender .back { background: var(--lavender-bg); color: #4a148c; border-left: 5px solid #e1bee7; }
        .content-lines { background-image: linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px); background-size: 100% 2rem; line-height: 2rem; height: 100%; font-family: 'Courier Prime', monospace; overflow-y: auto; white-space: pre-wrap; }

        /* Lock Decoration */
        .lock-strap { position: absolute; top: 50%; right: -15px; transform: translateY(-50%); width: 100px; height: 70px; background: var(--cover-dark); border-radius: 5px; border: 2px dashed rgba(0,0,0,0.3); box-shadow: 5px 0 10px rgba(0,0,0,0.3); z-index: 2; }
        .brass-lock { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); width: 120px; height: 50px; z-index: 3; background: linear-gradient(to bottom, var(--brass-light), var(--brass-dark), var(--brass-light)); border-radius: 8px; border: 1px solid var(--brass-dark); box-shadow: 0 4px 8px rgba(0,0,0,0.4); display: flex; justify-content: space-evenly; align-items: center; }
        .lock-dial { width: 20px; height: 35px; background: #333; color: white; display: flex; justify-content: center; align-items: center; font-family: 'Courier Prime', monospace; border-radius: 3px; }

        /* Controls */
        .ui-controls { position: fixed; bottom: 2rem; display: flex; gap: 1rem; z-index: 200; }
        .btn { background: #fff; padding: 0.6rem 1.5rem; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-family: sans-serif; transition: 0.2s; }
        .btn-primary { background: #4a5a63; color: white; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #fdf5e6; padding: 2rem; border-radius: 10px; width: 400px; position: relative; border: 2px solid #8c6a3a; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #5d4037; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ccc; border-radius: 5px; font-family: sans-serif; }
    </style>
</head>
<body>

    <div class="book-container" id="book">
        
        <% pages.reverse().forEach((page, index) => { %>
            <div class="page <%= page.page_style %>" id="p<%= index + 1 %>">
                <div class="front">
                    <div style="font-size: 0.8rem; opacity: 0.6;"><%= new Date(page.created_at).toLocaleDateString('id-ID') %></div>
                    <h2 class="text-xl font-bold mb-2 mt-1"><%= page.nickname %></h2>
                    <div class="content-lines"><%= page.content %></div>
                    
                    <% if (user && user.id === page.author_id) { %>
                        <div class="mt-auto flex justify-end gap-2 opacity-100 z-50">
                            <button type="button" 
                                onclick="openEditModal('<%= page.id %>', `<%= page.content %>`)" 
                                class="text-blue-600 text-xs font-bold border border-blue-400 px-2 py-1 rounded hover:bg-blue-100">
                                EDIT
                            </button>
                            <form action="/delete/<%= page.id %>" method="POST" style="display:inline;">
                                <button class="text-red-600 text-xs font-bold border border-red-400 px-2 py-1 rounded hover:bg-red-100">HAPUS</button>
                            </form>
                        </div>
                    <% } %>
                </div>
                <div class="back"></div>
            </div>
        <% }) %>

        <div class="page cover" id="p0">
            <div class="front">
                <div style="font-size: 1.4rem; font-weight: bold; color: #2c3e50; text-align: center;">VIRTUAL DIARY</div>
                <div style="font-size: 0.8rem; letter-spacing: 2px; text-align: center; margin-bottom: 2rem;">GROUP E3</div>
                
                <div class="bg-white/50 p-4 rounded text-center w-3/4 backdrop-blur-sm shadow-inner">
                    <% if (user) { %>
                        <p class="text-sm">Halo, <b><%= user.nickname %></b></p>
                        <a href="/logout" class="text-xs text-red-600 font-bold underline">Logout</a>
                    <% } else { %>
                        <p class="text-sm font-bold">Buku Terkunci</p>
                        <p class="text-xs">Login untuk menulis.</p>
                    <% } %>
                </div>

                <div class="lock-strap"></div>
                <div class="brass-lock">
                    <div class="lock-dial"><%= user ? 'O' : 'L' %></div>
                    <div class="lock-dial"><%= user ? 'P' : 'C' %></div>
                    <div class="lock-dial"><%= user ? 'N' : 'K' %></div>
                </div>
            </div>
            <div class="back bg-gray-100">
                <h2 class="text-2xl font-bold mb-4 text-center">Tentang Kami</h2>
                <p class="text-center text-sm italic">"Menyimpan kenangan dalam kode."</p>
                <div class="mt-auto text-center text-xs text-gray-500">Total: <%= pages.length %> Halaman</div>
            </div>
        </div>

    </div>

    <div class="ui-controls">
        <button class="btn" onclick="goPrev()">←</button>
        <% if (user) { %>
            <button class="btn btn-primary" onclick="openModal('writeModal')">✍ Tulis</button>
        <% } else { %>
            <button class="btn" onclick="openModal('loginModal')">Login</button>
            <button class="btn" onclick="openModal('registerModal')">Daftar</button>
        <% } %>
        <button class="btn" onclick="goNext()">→</button>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('registerModal')">&times;</span>
            <h2 class="text-xl font-bold mb-4 font-sans text-center">Daftar</h2>
            <form action="/register" method="POST">
                <input type="text" name="nickname" placeholder="Nama Pena" required>
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary w-full">Daftar</button>
            </form>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
            <h2 class="text-xl font-bold mb-4 font-sans text-center">Login</h2>
            <form action="/login" method="POST">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary w-full">Masuk</button>
            </form>
        </div>
    </div>

    <div id="writeModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('writeModal')">&times;</span>
            <h2 class="text-xl font-bold mb-2 font-sans">Halaman Baru</h2>
            <form action="/add" method="POST">
                <label class="text-sm font-bold">Tema Kertas:</label>
                <select name="style">
                    <option value="classic">Classic (Kuning)</option>
                    <option value="midnight">Midnight (Gelap)</option>
                    <option value="lavender">Lavender (Ungu)</option>
                </select>
                <textarea name="content" rows="5" placeholder="Tulis di sini..." required></textarea>
                <button type="submit" class="btn btn-primary w-full">Terbitkan</button>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('editModal')">&times;</span>
            <h2 class="text-xl font-bold mb-2 font-sans">Edit Cerita</h2>
            <form id="editForm" method="POST">
                <textarea id="editContent" name="content" rows="8" required></textarea>
                <button type="submit" class="btn btn-primary w-full bg-blue-600 text-white">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <script>
        // Modal Logic
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openEditModal(id, content) {
            document.getElementById('editForm').action = '/update/' + id;
            document.getElementById('editContent').value = content;
            document.getElementById('editModal').style.display = 'flex';
        }
        window.onclick = function(e) { if(e.target.classList.contains('modal')) e.target.style.display = "none"; }

        // Flipbook Logic
        const book = document.getElementById('book');
        const pages = Array.from(document.querySelectorAll('.page')).reverse();
        let currentLocation = 0;
        let totalPages = pages.length;

        function goNext() {
            if (currentLocation < totalPages) {
                if (currentLocation === 0) book.classList.add('open');
                const page = pages[currentLocation];
                page.classList.add('flipped');
                page.style.zIndex = currentLocation + 1;
                currentLocation++;
            }
        }

        function goPrev() {
            if (currentLocation > 0) {
                currentLocation--;
                const page = pages[currentLocation];
                page.classList.remove('flipped');
                page.style.zIndex = totalPages - currentLocation;
                if (currentLocation === 0) book.classList.remove('open');
            }
        }

        pages.forEach((page) => {
            page.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON' || e.target.tagName === 'TEXTAREA') return; 
                if (!page.classList.contains('flipped')) goNext(); else goPrev();
            });
        });
    </script>
</body>
</html>